generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model Project {
  id             String          @id @default(cuid())
  title          String
  department     String
  type           String
  priority       String
  status         String          @default("Pending")
  description    String
  sourceQuote    String?
  startDate      DateTime?
  dueDate        DateTime?
  progress       Int             @default(0)
  color          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  chatSessions   ChatSession[]
  risks          ProjectRisk[]
  reports        Report[]
  sherlockAudits SherlockAudit[]
  tags           Tag[]
  lists          TaskList[]
  members        ProjectMember[]
}

model TaskList {
  id          String   @id @default(cuid())
  name        String
  description String?
  position    Int      @default(0)
  color       String?
  projectId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tasks       Task[]
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, position])
}

model Task {
  id             String           @id @default(cuid())
  title          String
  description    String?
  position       Int              @default(0)
  startDate      DateTime?
  dueDate        DateTime?
  estimatedHours Float?
  actualHours    Float?
  storyPoints    Int?
  progress       Int              @default(0)
  parentId       String?
  listId         String
  statusId       String
  assigneeId     String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  technicalNotes String?
  assignee       User?            @relation("AssignedTasks", fields: [assigneeId], references: [id])
  list           TaskList         @relation(fields: [listId], references: [id], onDelete: Cascade)
  parent         Task?            @relation("TaskSubtasks", fields: [parentId], references: [id], onDelete: Cascade)
  subtasks       Task[]           @relation("TaskSubtasks")
  status         TaskStatus       @relation(fields: [statusId], references: [id])
  attachments    TaskAttachment[]
  comments       TaskComment[]
  successors     TaskDependency[] @relation("PredecessorTask")
  predecessors   TaskDependency[] @relation("SuccessorTask")
  tags           Tag[]            @relation("TagToTask")

  @@index([listId])
  @@index([statusId])
  @@index([assigneeId])
  @@index([parentId])
  @@index([dueDate])
  @@index([listId, position])
}

model TaskStatus {
  id        String  @id @default(cuid())
  name      String  @unique
  color     String  @default("#6B7280")
  position  Int     @default(0)
  isDefault Boolean @default(false)
  isClosed  Boolean @default(false)
  tasks     Task[]
}

model TaskDependency {
  id            String   @id @default(cuid())
  predecessorId String
  successorId   String
  type          String   @default("FS")
  lagDays       Int      @default(0)
  createdAt     DateTime @default(now())
  predecessor   Task     @relation("PredecessorTask", fields: [predecessorId], references: [id], onDelete: Cascade)
  successor     Task     @relation("SuccessorTask", fields: [successorId], references: [id], onDelete: Cascade)

  @@unique([predecessorId, successorId])
}

model TaskComment {
  id        String   @id @default(cuid())
  content   String
  taskId    String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation("TaskComments", fields: [authorId], references: [id], onDelete: Cascade)
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model TaskAttachment {
  id         String   @id @default(cuid())
  filename   String
  filepath   String
  filesize   Int
  mimetype   String
  taskId     String
  uploaderId String
  createdAt  DateTime @default(now())
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploader   User     @relation("TaskAttachments", fields: [uploaderId], references: [id], onDelete: Cascade)
}

model Tag {
  id        String  @id @default(cuid())
  name      String
  color     String  @default("#3B82F6")
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks     Task[]  @relation("TagToTask")

  @@unique([projectId, name])
}

model TeamMood {
  id              String   @id @default(cuid())
  departmentName  String
  sentimentScore  Int
  dominantEmotion String
  keyConcerns     String?
  detectedAt      DateTime @default(now())

  @@index([departmentName])
  @@index([detectedAt])
}

model ProjectRisk {
  id        String  @id @default(cuid())
  projectId String
  riskLevel String
  reason    String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Report {
  id        String   @id @default(cuid())
  title     String
  type      String   @default("Weekly")
  content   String
  projectId String?
  authorId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  metadata  Json?
  author    User?    @relation(fields: [authorId], references: [id])
  project   Project? @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([authorId])
}

model User {
  id                 String           @id @default(cuid())
  name               String?
  username           String           @unique
  email              String?          @unique
  password           String
  image              String?
  roleId             String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  mustChangePassword Boolean          @default(false)
  chatSessions       ChatSession[]
  reports            Report[]
  sherlockAudits     SherlockAudit[]  @relation("SherlockAudits")
  assignedTasks      Task[]           @relation("AssignedTasks")
  attachments        TaskAttachment[] @relation("TaskAttachments")
  comments           TaskComment[]    @relation("TaskComments")
  role               Role             @relation(fields: [roleId], references: [id])
  projectMemberships ProjectMember[]
}

model Role {
  id          String       @id @default(cuid())
  code        String       @unique
  name        String
  description String?
  isSystem    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  users       User[]
  permissions Permission[] @relation("PermissionToRole")
}

model Permission {
  id          String   @id @default(cuid())
  action      String
  resource    String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  roles       Role[]   @relation("PermissionToRole")

  @@unique([action, resource])
}

model AiUsageLog {
  id                String   @id @default(cuid())
  modelName         String
  actionType        String
  promptTokens      Int      @default(0)
  completionTokens  Int      @default(0)
  totalTokens       Int      @default(0)
  projectId         String?
  userId            String?
  createdAt         DateTime @default(now())
  remainingRequests Int?
  remainingTokens   Int?

  @@index([createdAt])
  @@index([modelName])
  @@index([userId])
}

model ChatSession {
  id        String        @id @default(cuid())
  title     String?
  userId    String
  projectId String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]
  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
}

model ChatMessage {
  id              String      @id @default(cuid())
  sessionId       String
  role            String
  content         String
  toolInvocations Json?
  createdAt       DateTime    @default(now())
  session         ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model SherlockAudit {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("DRAFT")
  projectId   String?
  authorId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  author      User     @relation("SherlockAudits", fields: [authorId], references: [id])
  project     Project? @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([authorId])
}

model MeasureUnit {
  id                String             @id @default(cuid())
  name              String
  abbreviation      String             @unique
  type              UnitType
  conversionFactor  Float?
  isBase            Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  ingredients       Ingredient[]
  recipeIngredients RecipeIngredient[]

  @@map("measure_units")
}

model Category {
  id          String       @id @default(cuid())
  name        String
  description String?
  parentId    String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  parent      Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[]   @relation("CategoryHierarchy")
  ingredients Ingredient[]

  @@index([parentId])
  @@map("categories")
}

model RecipeCategory {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  recipes     Recipe[]

  @@map("recipe_categories")
}

model RecipeFamily {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  recipes     Recipe[]

  @@map("recipe_families")
}

model Supplier {
  id           String       @id @default(cuid())
  name         String
  code         String?      @unique
  email        String?
  phone        String?
  address      String?
  taxId        String?
  paymentTerms String?
  minOrder     Float?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  ingredients  Ingredient[]

  @@map("suppliers")
}

model Ingredient {
  id                String             @id @default(cuid())
  name              String
  normalizedName    String?
  description       String?
  reference         String?            @unique
  categoryId        String
  unitTypeId        String
  cost              Float
  taxRate           Float              @default(0.10)
  isBuyable         Boolean            @default(true)
  isSellable        Boolean            @default(false)
  currentStock      Float?
  minStock          Float?
  maxStock          Float?
  shelfLife         Int?
  storageTemp       Float?
  yield             Float?
  supplierId        String?
  aiNormalizedGroup String?
  aiConfidence      Float?
  status            IngredientStatus   @default(ACTIVE)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  category          Category           @relation(fields: [categoryId], references: [id])
  supplier          Supplier?          @relation(fields: [supplierId], references: [id])
  unitType          MeasureUnit        @relation(fields: [unitTypeId], references: [id])
  inventoryRecords  InventoryRecord[]
  priceHistory      PriceHistory[]
  recipeIngredients RecipeIngredient[]
  wasteRecords      WasteRecord[]

  @@index([categoryId])
  @@index([supplierId])
  @@index([normalizedName])
  @@index([aiNormalizedGroup])
  @@map("ingredients")
}

model Recipe {
  id              String             @id @default(cuid())
  name            String
  description     String?
  categoryId      String
  familyId        String?
  prepTime        Int?
  cookTime        Int?
  servings        Int?
  steps           String[]
  photos          String[]
  videos          String[]
  theoreticalCost Float?
  realCost        Float?
  variance        Float?
  variancePercent Float?
  protocoloDeSala String?
  aiGenerated     Boolean            @default(false)
  aiPrompt        String?
  aiVersion       String?
  status          RecipeStatus       @default(DRAFT)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  productionBatch ProductionBatch[]
  ingredients     RecipeIngredient[]
  usedInRecipes   RecipeSubrecipe[]  @relation("ChildRecipe")
  subrecipesUsed  RecipeSubrecipe[]  @relation("ParentRecipe")
  category        RecipeCategory     @relation(fields: [categoryId], references: [id])
  family          RecipeFamily?      @relation(fields: [familyId], references: [id])
  voiceAudits     VoiceAudit[]

  @@index([categoryId])
  @@index([familyId])
  @@index([aiGenerated])
  @@index([status])
  @@map("recipes")
}

model RecipeIngredient {
  id           String      @id @default(cuid())
  recipeId     String
  ingredientId String
  quantity     Float
  unitId       String
  notes        String?
  order        Int         @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  ingredient   Ingredient  @relation(fields: [ingredientId], references: [id])
  recipe       Recipe      @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  unit         MeasureUnit @relation(fields: [unitId], references: [id])

  @@unique([recipeId, ingredientId])
  @@index([recipeId])
  @@index([ingredientId])
  @@map("recipe_ingredients")
}

model RecipeSubrecipe {
  id        String   @id @default(cuid())
  parentId  String
  childId   String
  quantity  Float
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  child     Recipe   @relation("ChildRecipe", fields: [childId], references: [id])
  parent    Recipe   @relation("ParentRecipe", fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([parentId, childId])
  @@map("recipe_subrecipes")
}

model InventoryRecord {
  id             String          @id @default(cuid())
  ingredientId   String
  quantity       Float
  location       String?
  expiryDate     DateTime?
  productionDate DateTime?
  freezeDate     DateTime?
  openDate       DateTime?
  lotNumber      String?
  batchNumber    String?
  status         InventoryStatus @default(AVAILABLE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  ingredient     Ingredient      @relation(fields: [ingredientId], references: [id])

  @@index([ingredientId])
  @@index([expiryDate])
  @@index([status])
  @@map("inventory_records")
}

model WasteRecord {
  id                String      @id @default(cuid())
  ingredientId      String
  quantity          Float
  reason            WasteReason
  notes             String?
  responsibleUserId String?
  detectedByAI      Boolean     @default(false)
  audioTranscript   String?
  confidenceScore   Float?
  createdAt         DateTime    @default(now())
  ingredient        Ingredient  @relation(fields: [ingredientId], references: [id])

  @@index([ingredientId])
  @@index([reason])
  @@index([detectedByAI])
  @@index([createdAt])
  @@map("waste_records")
}

model PriceHistory {
  id           String     @id @default(cuid())
  ingredientId String
  price        Float
  effectiveAt  DateTime   @default(now())
  supplierId   String?
  reason       String?
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  @@index([ingredientId])
  @@index([effectiveAt])
  @@map("price_history")
}

model VoiceAudit {
  id                String   @id @default(cuid())
  recipeId          String
  audioUrl          String
  transcription     String
  discrepancies     Json
  score             Float
  modelVersion      String?
  auditorUserId     String?
  productionBatchId String?
  createdAt         DateTime @default(now())
  recipe            Recipe   @relation(fields: [recipeId], references: [id])

  @@index([recipeId])
  @@index([score])
  @@index([createdAt])
  @@map("voice_audits")
}

model ProductionBatch {
  id               String           @id @default(cuid())
  recipeId         String
  quantity         Float
  plannedDate      DateTime?
  producedDate     DateTime?
  plannedCost      Float?
  actualCost       Float?
  supervisorUserId String?
  status           ProductionStatus @default(PLANNED)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  recipe           Recipe           @relation(fields: [recipeId], references: [id])

  @@index([recipeId])
  @@index([status])
  @@index([producedDate])
  @@map("production_batches")
}

enum ProjectRole {
  OWNER
  MANAGER
  EDITOR
  VIEWER
}

model ProjectMember {
  id        String      @id @default(cuid())
  userId    String
  projectId String
  role      ProjectRole @default(VIEWER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
  @@map("project_members")
}

enum UnitType {
  WEIGHT
  VOLUME
  UNIT
}

enum IngredientStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
}

enum RecipeStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum InventoryStatus {
  AVAILABLE
  RESERVED
  EXPIRED
  QUARANTINE
}

enum WasteReason {
  EXPIRED
  BURNED
  SPOILED
  QUALITY_ISSUE
  OVERPRODUCTION
  YIELD_LOSS
  OTHER
}

enum ProductionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ─── ATC: Reservas ───────────────────────────────────────────

model Reservation {
  id               String                    @id @default(cuid())
  guestName        String
  guestEmail       String?
  guestPhone       String?
  partySize        Int
  date             DateTime
  time             String
  channelId        String
  status           ReservationStatus         @default(PENDING)
  notes            String?
  externalId       String?                   @unique
  externalSource   String?
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  channel          ReservationChannel        @relation(fields: [channelId], references: [id])
  modifications    ReservationModification[]
  paymentRecoveries PaymentRecovery[]
  groupReservation GroupReservation?
  invoices         Invoice[]

  @@index([date])
  @@index([status])
  @@index([channelId])
  @@index([externalId])
  @@map("reservations")
}

model ReservationChannel {
  id           String        @id @default(cuid())
  name         String
  code         String        @unique
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  reservations Reservation[]

  @@map("reservation_channels")
}

model WaitingList {
  id            String   @id @default(cuid())
  guestName     String
  guestPhone    String
  partySize     Int
  requestedDate DateTime
  priority      Int      @default(0)
  notified      Boolean  @default(false)
  notes         String?
  createdAt     DateTime @default(now())

  @@index([requestedDate])
  @@index([priority])
  @@map("waiting_list")
}

model ReservationModification {
  id            String      @id @default(cuid())
  reservationId String
  field         String
  oldValue      String?
  newValue      String?
  modifiedBy    String?
  createdAt     DateTime    @default(now())
  reservation   Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@map("reservation_modifications")
}

// ─── ATC: Consultas IA ───────────────────────────────────────

model Query {
  id              String            @id @default(cuid())
  guestInput      String
  categoryId      String
  channel         String            @default("WEB")
  status          QueryStatus       @default(OPEN)
  resolvedBy      String?
  confidenceScore Float?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  category        QueryCategory     @relation(fields: [categoryId], references: [id])
  resolutions     QueryResolution[]

  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
  @@map("queries")
}

model QueryCategory {
  id      String  @id @default(cuid())
  name    String
  code    String  @unique
  queries Query[]

  @@map("query_categories")
}

model KnowledgeBase {
  id         String   @id @default(cuid())
  title      String
  content    String
  categoryId String?
  embedding  String?
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([categoryId])
  @@index([active])
  @@map("knowledge_base")
}

model QueryResolution {
  id           String   @id @default(cuid())
  queryId      String
  responseText String
  source       String   @default("AI")
  feedback     Int?
  createdAt    DateTime @default(now())
  query        Query    @relation(fields: [queryId], references: [id], onDelete: Cascade)

  @@index([queryId])
  @@map("query_resolutions")
}

// ─── ATC: Operaciones ────────────────────────────────────────

model Incident {
  id          String           @id @default(cuid())
  type        IncidentType
  severity    IncidentSeverity @default(LOW)
  description String
  status      IncidentStatus   @default(OPEN)
  assignedTo  String?
  resolvedAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([type])
  @@index([status])
  @@index([severity])
  @@map("incidents")
}

model PaymentRecovery {
  id            String      @id @default(cuid())
  reservationId String
  amount        Float
  failureReason String?
  attempts      Int         @default(0)
  status        String      @default("PENDING")
  resolvedAt    DateTime?
  createdAt     DateTime    @default(now())
  reservation   Reservation @relation(fields: [reservationId], references: [id])

  @@index([reservationId])
  @@index([status])
  @@map("payment_recoveries")
}

model WeatherAlert {
  id          String    @id @default(cuid())
  alertType   String
  threshold   Float?
  isActive    Boolean   @default(true)
  action      String    @default("NOTIFY")
  triggeredAt DateTime?
  createdAt   DateTime  @default(now())

  @@map("weather_alerts")
}

model GroupReservation {
  id                  String      @id @default(cuid())
  reservationId       String      @unique
  coordinatorId       String?
  contractUrl         String?
  depositPaid         Boolean     @default(false)
  specialRequirements String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  reservation         Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@map("group_reservations")
}

// ─── ATC: Back-Office ────────────────────────────────────────

model EmailInbox {
  id         String   @id @default(cuid())
  fromEmail  String
  subject    String
  body       String
  aiLabel    String?
  aiPriority Int?
  isRead     Boolean  @default(false)
  assignedTo String?
  receivedAt DateTime @default(now())

  @@index([isRead])
  @@index([aiPriority])
  @@index([receivedAt])
  @@map("email_inbox")
}

model Invoice {
  id            String       @id @default(cuid())
  guestName     String
  guestEmail    String?
  items         Json
  subtotal      Float
  tax           Float
  total         Float
  status        String       @default("DRAFT")
  reservationId String?
  pdfUrl        String?
  generatedAt   DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  reservation   Reservation? @relation(fields: [reservationId], references: [id])

  @@index([status])
  @@index([reservationId])
  @@map("invoices")
}

model GiftVoucher {
  id             String               @id @default(cuid())
  code           String               @unique
  value          Float
  remainingValue Float
  status         GiftVoucherStatus    @default(ACTIVE)
  purchasedBy    String?
  expiresAt      DateTime?
  qrCode         String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  transactions   VoucherTransaction[]

  @@index([status])
  @@index([expiresAt])
  @@map("gift_vouchers")
}

model VoucherTransaction {
  id        String      @id @default(cuid())
  voucherId String
  amount    Float
  type      String
  notes     String?
  createdAt DateTime    @default(now())
  voucher   GiftVoucher @relation(fields: [voucherId], references: [id])

  @@index([voucherId])
  @@map("voucher_transactions")
}

// ─── ATC: Enums ──────────────────────────────────────────────

enum ReservationStatus {
  PENDING
  CONFIRMED
  SEATED
  CANCELLED
  NO_SHOW
  WAITING
}

enum QueryStatus {
  OPEN
  RESOLVED
  ESCALATED
}

enum IncidentType {
  PAYMENT
  WEATHER
  COMPLAINT
  GROUP
  OTHER
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum GiftVoucherStatus {
  ACTIVE
  USED
  EXPIRED
  CANCELLED
}
