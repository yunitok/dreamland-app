// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// PROJECT MANAGEMENT
// =============================================================================

model Project {
  id          String  @id @default(cuid())
  title       String
  department  String
  type        String // "Problem" | "Idea" | "Initiative"
  priority    String // "High" | "Medium" | "Low"
  status      String  @default("Pending") // "Active" | "Pending" | "Done"
  description String
  sourceQuote String?

  // Project Management Fields
  startDate DateTime?
  dueDate   DateTime?
  progress  Int       @default(0) // 0-100%
  color     String? // For visual identification (hex color)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  risks          ProjectRisk[]
  lists          TaskList[]
  tags           Tag[]
  chatSessions   ChatSession[]
  reports        Report[]
  sherlockAudits SherlockAudit[]
}

model TaskList {
  id          String  @id @default(cuid())
  name        String
  description String?
  position    Int     @default(0) // For ordering lists
  color       String? // Hex color for visual identification

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId]) // Get lists for a project
  @@index([projectId, position]) // Ordered lists
}

model Task {
  id             String  @id @default(cuid())
  title          String
  description    String?
  technicalNotes String? // Acceptance criteria or technical details
  position       Int     @default(0) // For ordering within list

  // Dates
  startDate DateTime?
  dueDate   DateTime?

  // Estimation & Tracking
  estimatedHours Float?
  actualHours    Float?
  storyPoints    Int?

  // Progress (0-100)
  progress Int @default(0)

  // Hierarchy - Self-referential for subtasks
  parentId String?
  parent   Task?   @relation("TaskSubtasks", fields: [parentId], references: [id], onDelete: Cascade)
  subtasks Task[]  @relation("TaskSubtasks")

  // Relations
  listId String
  list   TaskList @relation(fields: [listId], references: [id], onDelete: Cascade)

  statusId String
  status   TaskStatus @relation(fields: [statusId], references: [id])

  assigneeId String?
  assignee   User?   @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)

  // Dependencies
  predecessors TaskDependency[] @relation("SuccessorTask")
  successors   TaskDependency[] @relation("PredecessorTask")

  // Collaboration
  comments    TaskComment[]
  attachments TaskAttachment[]
  tags        Tag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance indexes for frequent queries
  @@index([listId]) // Filter tasks by list
  @@index([statusId]) // Filter by status (Kanban view)
  @@index([assigneeId]) // "My tasks" queries
  @@index([parentId]) // Subtask queries
  @@index([dueDate]) // Sort/filter by due date
  @@index([listId, position]) // Ordering within lists
}

model TaskStatus {
  id        String  @id @default(cuid())
  name      String  @unique // Global status name
  color     String  @default("#6B7280") // gray-500
  position  Int     @default(0) // For ordering columns in Kanban
  isDefault Boolean @default(false) // Default status for new tasks
  isClosed  Boolean @default(false) // Marks task as "done"

  tasks Task[]
}

model TaskDependency {
  id String @id @default(cuid())

  // The task that must be completed first
  predecessorId String
  predecessor   Task   @relation("PredecessorTask", fields: [predecessorId], references: [id], onDelete: Cascade)

  // The task that depends on the predecessor
  successorId String
  successor   Task   @relation("SuccessorTask", fields: [successorId], references: [id], onDelete: Cascade)

  // Dependency types:
  // FS = Finish-to-Start (most common - successor starts after predecessor finishes)
  // SS = Start-to-Start (both start together)
  // FF = Finish-to-Finish (both finish together)
  // SF = Start-to-Finish (successor finishes when predecessor starts)
  type String @default("FS")

  // Lag days (positive = delay, negative = lead time)
  lagDays Int @default(0)

  createdAt DateTime @default(now())

  @@unique([predecessorId, successorId])
}

model TaskComment {
  id      String @id @default(cuid())
  content String

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation("TaskComments", fields: [authorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TaskAttachment {
  id       String @id @default(cuid())
  filename String
  filepath String // Path to stored file
  filesize Int // Size in bytes
  mimetype String

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  uploaderId String
  uploader   User   @relation("TaskAttachments", fields: [uploaderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model Tag {
  id    String @id @default(cuid())
  name  String
  color String @default("#3B82F6") // blue-500

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  tasks Task[]

  @@unique([projectId, name])
}

// =============================================================================
// TEAM SENTIMENT
// =============================================================================

model TeamMood {
  id              String   @id @default(cuid())
  departmentName  String
  sentimentScore  Int // 0-100 (100 = very happy, 0 = very stressed)
  dominantEmotion String
  keyConcerns     String?
  detectedAt      DateTime @default(now())

  @@index([departmentName]) // Filter by department
  @@index([detectedAt]) // Historical queries
}

model ProjectRisk {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  riskLevel String // "High" | "Medium" | "Low"
  reason    String
}

model Report {
  id       String @id @default(cuid())
  title    String
  type     String @default("Weekly") // "Weekly", "Risk", "Financial", "SentimentAnalysis", "ProjectCatalog"
  content  String @db.Text
  metadata Json?

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  authorId String?
  author   User?   @relation(fields: [authorId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([authorId])
}

model User {
  id                 String   @id @default(cuid())
  name               String?
  username           String   @unique
  email              String?  @unique
  password           String
  image              String?
  roleId             String
  role               Role     @relation(fields: [roleId], references: [id])
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  mustChangePassword Boolean  @default(false)

  // Task Management Relations
  assignedTasks  Task[]           @relation("AssignedTasks")
  comments       TaskComment[]    @relation("TaskComments")
  attachments    TaskAttachment[] @relation("TaskAttachments")
  chatSessions   ChatSession[]
  reports        Report[]
  sherlockAudits SherlockAudit[]  @relation("SherlockAudits")
}

model Role {
  id          String       @id @default(cuid())
  code        String       @unique // System Code: SUPER_ADMIN, STRATEGIC_PM, TEAM_LEAD, TEAM_MEMBER
  name        String // Display Name: Super Admin, Team Lead
  description String?
  isSystem    Boolean      @default(false)
  users       User[]
  permissions Permission[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Permission {
  id          String   @id @default(cuid())
  action      String
  resource    String
  description String?
  roles       Role[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([action, resource])
}

// =============================================================================
// AI USAGE TRACKING
// =============================================================================

model AiUsageLog {
  id         String @id @default(cuid())
  modelName  String
  actionType String // e.g., "VoiceCommand"

  // Token Usage
  promptTokens     Int @default(0)
  completionTokens Int @default(0)
  totalTokens      Int @default(0)

  // Metadata
  projectId String?
  userId    String?

  // Provider Snapshot
  remainingRequests Int?
  remainingTokens   Int?

  createdAt DateTime @default(now())

  @@index([createdAt]) // Analytics queries by date
  @@index([modelName]) // Filter by AI provider
  @@index([userId]) // User usage tracking
}

// =============================================================================
// CHAT & AI AGENT
// =============================================================================

model ChatSession {
  id    String  @id @default(cuid())
  title String? // Optional title for the conversation

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  messages ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
}

model ChatMessage {
  id String @id @default(cuid())

  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role    String // system, user, assistant, data
  content String @db.Text

  // Store tool invocations/results as JSON structure
  toolInvocations Json?

  createdAt DateTime @default(now())

  @@index([sessionId])
}

// =============================================================================
// SHERLOCK (AUDIT SYSTEM)
// =============================================================================

model SherlockAudit {
  id          String  @id @default(cuid())
  title       String
  description String?
  status      String  @default("DRAFT") // DRAFT, IN_PROGRESS, COMPLETED

  // Relations
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  authorId String
  author   User   @relation("SherlockAudits", fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([authorId])
}

// ============================================================================
// GESTIN DE UNIDADES DE MEDIDA (Adoptado de Gstock)
// ============================================================================

model MeasureUnit {
  id               String   @id @default(cuid())
  name             String // "Kilogramo", "Litro", "Unidad"
  abbreviation     String   @unique // "Kg", "L", "Ud"
  type             UnitType
  conversionFactor Float? // Conversi贸n a unidad base del tipo
  isBase           Boolean  @default(false) // true para Kg, L, Ud b谩sicas

  ingredients       Ingredient[]
  recipeIngredients RecipeIngredient[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("measure_units")
}

enum UnitType {
  WEIGHT // Peso (Kg, g, mg)
  VOLUME // Volumen (L, mL, cl)
  UNIT // Unidad (Ud, docena, caja)
}

// ============================================================================
// GESTIN DE CATEGORAS
// ============================================================================

model Category {
  id          String     @id @default(cuid())
  name        String
  description String?
  parentId    String? // Para jerarqu铆as
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  ingredients Ingredient[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@map("categories")
}

model RecipeCategory {
  id          String  @id @default(cuid())
  name        String
  description String?

  recipes Recipe[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("recipe_categories")
}

model RecipeFamily {
  id          String  @id @default(cuid())
  name        String
  description String?

  recipes Recipe[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("recipe_families")
}

// ============================================================================
// GESTIN DE PROVEEDORES
// ============================================================================

model Supplier {
  id      String  @id @default(cuid())
  name    String
  code    String? @unique // C贸digo interno
  email   String?
  phone   String?
  address String?
  taxId   String? // CIF/NIF

  // Condiciones comerciales
  paymentTerms String? // "30 d铆as", "contado", etc.
  minOrder     Float? // Pedido m铆nimo

  ingredients Ingredient[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("suppliers")
}

// ============================================================================
// GESTIN DE INGREDIENTES/PRODUCTOS
// ============================================================================

model Ingredient {
  id             String  @id @default(cuid())
  name           String
  normalizedName String? //  IA: nombre can贸nico para b煤squedas
  description    String?
  reference      String? @unique // SKU/c贸digo de producto

  // Categorizaci贸n (Gstock)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  // Unidad de medida (Gstock)
  unitTypeId String
  unitType   MeasureUnit @relation(fields: [unitTypeId], references: [id])

  // Precios y costes (Yurest + Gstock)
  cost    Float // Precio de coste actual
  taxRate Float @default(0.10) // IVA (10% por defecto)

  // Flags de compra/venta (Gstock)
  isBuyable  Boolean @default(true)
  isSellable Boolean @default(false)

  // Inventario (Gstock)
  currentStock Float?
  minStock     Float? // Alerta de bajo stock
  maxStock     Float? // Stock m谩ximo recomendado

  // Trazabilidad y conservaci贸n (Yurest)
  shelfLife   Int? // D铆as de vida 煤til
  storageTemp Float? // Temperatura de conservaci贸n (掳C)
  yield       Float? // Rendimiento tras limpieza (0-1, ej: 0.85 = 85%)

  // Proveedor (Gstock)
  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  //  Sherlock exclusivo: Normalizaci贸n IA
  aiNormalizedGroup String? // Grupo de ingredientes similares
  aiConfidence      Float? // Confianza de la normalizaci贸n (0-1)

  // Estado
  status IngredientStatus @default(ACTIVE)

  // Relaciones
  recipeIngredients RecipeIngredient[]
  inventoryRecords  InventoryRecord[]
  wasteRecords      WasteRecord[]
  priceHistory      PriceHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([supplierId])
  @@index([normalizedName])
  @@index([aiNormalizedGroup])
  @@map("ingredients")
}

enum IngredientStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
}

// ============================================================================
// GESTIN DE RECETAS
// ============================================================================

model Recipe {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text

  // Categorizaci贸n (Yurest + Gstock)
  categoryId String
  category   RecipeCategory @relation(fields: [categoryId], references: [id])
  familyId   String?
  family     RecipeFamily?  @relation(fields: [familyId], references: [id])

  // Detalles de preparaci贸n (Yurest)
  prepTime Int? // Minutos de preparaci贸n
  cookTime Int? // Minutos de cocci贸n
  servings Int? // N煤mero de raciones

  // Instrucciones (Yurest)
  steps String[] // Array de pasos detallados

  // Multimedia (Yurest)
  photos String[] // URLs de fotos
  videos String[] // URLs de videos

  // Costes (Yurest + Gstock)
  theoreticalCost Float? // Calculado autom谩ticamente
  realCost        Float? // Coste real del sistema
  variance        Float? // Diferencia (desperdicio potencial)
  variancePercent Float? // % de variaci贸n

  //  Sherlock exclusivo: Protocolo de Sala
  protocoloDeSala String? @db.Text // Instrucciones de servicio, emplatado, alergias

  //  Sherlock exclusivo: IA
  aiGenerated Boolean @default(false) // Generada por Chef GPT
  aiPrompt    String? @db.Text // Prompt usado para generar
  aiVersion   String? // Versi贸n del modelo IA usado

  // Estado y ciclo de vida (Yurest)
  status RecipeStatus @default(DRAFT)

  // Relaciones
  ingredients     RecipeIngredient[]
  subrecipesUsed  RecipeSubrecipe[]  @relation("ParentRecipe") // Subrecetas que usa esta receta
  usedInRecipes   RecipeSubrecipe[]  @relation("ChildRecipe") // Recetas que usan esta como subreceta
  voiceAudits     VoiceAudit[]
  productionBatch ProductionBatch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([familyId])
  @@index([aiGenerated])
  @@index([status])
  @@map("recipes")
}

enum RecipeStatus {
  DRAFT // Borrador
  ACTIVE // Activa
  ARCHIVED // Archivada
}

// ============================================================================
// RELACIONES RECETAS-INGREDIENTES
// ============================================================================

model RecipeIngredient {
  id           String      @id @default(cuid())
  recipeId     String
  recipe       Recipe      @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredientId String
  ingredient   Ingredient  @relation(fields: [ingredientId], references: [id])
  quantity     Float
  unitId       String
  unit         MeasureUnit @relation(fields: [unitId], references: [id])

  // Notas opcionales
  notes String? // "picado fino", "en juliana", etc.

  // Orden en la receta
  order Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([recipeId, ingredientId])
  @@index([recipeId])
  @@index([ingredientId])
  @@map("recipe_ingredients")
}

// ============================================================================
// SUBRECETAS (Gstock: Soporte jer谩rquico)
// ============================================================================

model RecipeSubrecipe {
  id       String @id @default(cuid())
  parentId String // Receta que usa la subreceta
  parent   Recipe @relation("ParentRecipe", fields: [parentId], references: [id], onDelete: Cascade)
  childId  String // Subreceta usada
  child    Recipe @relation("ChildRecipe", fields: [childId], references: [id])
  quantity Float

  // Notas
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([parentId, childId])
  @@map("recipe_subrecipes")
}

// ============================================================================
// CONTROL DE INVENTARIO
// ============================================================================

model InventoryRecord {
  id           String     @id @default(cuid())
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  quantity Float
  location String? // Almac茅n, c谩mara, congelador, etc.

  // Trazabilidad (Yurest)
  expiryDate     DateTime?
  productionDate DateTime?
  freezeDate     DateTime?
  openDate       DateTime?
  lotNumber      String?
  batchNumber    String?

  // Estado
  status InventoryStatus @default(AVAILABLE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ingredientId])
  @@index([expiryDate])
  @@index([status])
  @@map("inventory_records")
}

enum InventoryStatus {
  AVAILABLE // Disponible para uso
  RESERVED // Reservado para producci贸n
  EXPIRED // Caducado
  QUARANTINE // En cuarentena (calidad)
}

// ============================================================================
// CONTROL DE MERMAS/DESPERDICIOS
// ============================================================================

model WasteRecord {
  id           String     @id @default(cuid())
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  quantity Float
  reason   WasteReason
  notes    String?

  // Responsabilidad
  responsibleUserId String?

  //  Sherlock exclusivo: Detecci贸n IA
  detectedByAI    Boolean @default(false) // Detectado por auditor铆a IA
  audioTranscript String? @db.Text // Transcripci贸n del audio de la auditor铆a
  confidenceScore Float? // Confianza de la detecci贸n (0-1)

  createdAt DateTime @default(now())

  @@index([ingredientId])
  @@index([reason])
  @@index([detectedByAI])
  @@index([createdAt])
  @@map("waste_records")
}

enum WasteReason {
  EXPIRED // Caducado
  BURNED // Quemado
  SPOILED // Estropeado
  QUALITY_ISSUE // Problema de calidad
  OVERPRODUCTION // Sobreproducci贸n
  YIELD_LOSS // P茅rdida por rendimiento (limpieza, deshuese)
  OTHER // Otro motivo
}

// ============================================================================
// HISTRICO DE PRECIOS
// ============================================================================

model PriceHistory {
  id           String     @id @default(cuid())
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  price       Float
  effectiveAt DateTime @default(now())
  supplierId  String? // Opcional: precio de proveedor espec铆fico

  // Contexto
  reason String? // "Cambio de proveedor", "Subida IPC", etc.

  @@index([ingredientId])
  @@index([effectiveAt])
  @@map("price_history")
}

// ============================================================================
//  SHERLOCK EXCLUSIVO: AUDITORA POR VOZ
// ============================================================================

model VoiceAudit {
  id       String @id @default(cuid())
  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id])

  // Audio y transcripci贸n
  audioUrl      String
  transcription String @db.Text

  // An谩lisis IA
  discrepancies Json // Diferencias detectadas (JSON)
  score         Float // 0-100 (calidad de adherencia a receta)

  // IA metadata
  modelVersion String? // Versi贸n del modelo Whisper

  // Contexto
  auditorUserId     String? // Usuario que realiz贸 la auditor铆a
  productionBatchId String?

  createdAt DateTime @default(now())

  @@index([recipeId])
  @@index([score])
  @@index([createdAt])
  @@map("voice_audits")
}

// ============================================================================
// PRODUCCIN
// ============================================================================

model ProductionBatch {
  id       String @id @default(cuid())
  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id])

  quantity     Float // Cantidad producida
  plannedDate  DateTime?
  producedDate DateTime?

  // Costes
  plannedCost Float? // Coste planificado
  actualCost  Float? // Coste real

  // Responsable
  supervisorUserId String?

  status ProductionStatus @default(PLANNED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipeId])
  @@index([status])
  @@index([producedDate])
  @@map("production_batches")
}

enum ProductionStatus {
  PLANNED // Planificado
  IN_PROGRESS // En producci贸n
  COMPLETED // Completado
  CANCELLED // Cancelado
}

// ============================================================================
// GESTIN DE ENUMS Y LISTAS
// ============================================================================

// Razones de merma ya definidas en WasteReason enum
